
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Pipeline Stages &#8212; cishouseholds  documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to cishouseholds’s documentation!" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="index.html">
<p class="title">cishouseholds</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  Pipeline Stages
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ONS-SST/cis_households" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                

<nav id="bd-toc-nav">
    
</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pipeline-stages">
<h1>Pipeline Stages<a class="headerlink" href="#pipeline-stages" title="Permalink to this headline">¶</a></h1>
<p>Stages that can be run by the pipeline, when specified in the main pipeline configuration file.</p>
<span class="target" id="module-cishouseholds.pipeline.pipeline_stages"></span><dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.aggregated_output">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">aggregated_output</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">apply_aggregate_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_survey_table_to_aggregate</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_group</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_window_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order_window_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">apply_function_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_to_assign_list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.aggregated_output" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>apply_window</strong> – </p></li>
<li><p><strong>apply_groupby</strong> – </p></li>
<li><p><strong>aggregated_output</strong> – </p></li>
<li><p><strong>column_name_to_assign_list</strong> – </p></li>
<li><p><strong>column_group</strong> – </p></li>
<li><p><strong>column_window_list</strong> – </p></li>
<li><p><strong>function_list</strong> – </p></li>
<li><p><strong>column_list_to_apply_function</strong> – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.backup_files">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">backup_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_list</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">backup_directory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.backup_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Backup a list of files on the local or hdfs file system to a hdfs backup directory</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.blind_csv_to_table">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">blind_csv_to_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.blind_csv_to_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert a single csv file to a HDFS table by inferring a schema</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.calculate_household_level_populations">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">calculate_household_level_populations</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">address_lookup_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">postcode_lookup_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lsoa_cis_lookup_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">country_lookup_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">household_level_populations_table</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.calculate_household_level_populations" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate counts of households by CIS area 20 and country code 12 geographical groups used in the design weight
calculation.
Combines several lookup tables to get the necessary geographies linked to households, then sums households by
CIS area and country code.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>address_lookup_table</strong> – addressbase HIVE table name</p></li>
<li><p><strong>postcode_lookup_table</strong> – NSPL postcode lookup HIVE table name to join onto addressbase to get LSOA 11 and country code 12</p></li>
<li><p><strong>lsoa_cis_lookup_table</strong> – LSOA 11 to CIS lookup HIVE table name to get CIS area codes</p></li>
<li><p><strong>country_lookup_table</strong> – country lookup HIVE table name to get country names from country code 12</p></li>
<li><p><strong>household_level_populations_table</strong> – HIVE table to write household level populations to</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.csv_to_table">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">csv_to_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_operations</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.csv_to_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert a list of csv files into HDFS tables. Requires a schema.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.delete_tables_stage">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">delete_tables_stage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">Union</span><span class="p"><span class="pre">[</span></span><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pattern</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">protected_tables</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">drop_protected_tables</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.delete_tables_stage" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes HIVE tables. For use at the start of a pipeline run, to reset pipeline logs and data.
Should not be used in production, as all tables may be deleted.
Use one or more of the optional parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>prefix</strong> – remove all tables with a given table name prefix (see config for current prefix)</p></li>
<li><p><strong>table_names</strong> – one or more absolute table names to delete (including prefix)</p></li>
<li><p><strong>pattern</strong> – drop tables where table name matches pattern in SQL format (e.g. “%_responses_%”)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.execute_fill_forwards_events">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">execute_fill_forwards_events</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.execute_fill_forwards_events" title="Permalink to this definition">¶</a></dt>
<dd><p>Separates out the fill_forwards_event implementation of last observation carried forwards (LOCF) logic from STATA code</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_response_table</strong> – input table name for table containing the combined survey responses tables</p></li>
<li><p><strong>fill_forwards_table</strong> – output table name for table with applied fill_forwards_event dependent on complete survey dataset</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.execute_union_dependent_transformations">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">execute_union_dependent_transformations</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.execute_union_dependent_transformations" title="Permalink to this definition">¶</a></dt>
<dd><p>Transformations that require the union of the different input survey response files.
Includes filling forwards or backwards over time and deriving new information over time.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>unioned_survey_table</strong> – input table name for table containing the combined survey responses tables</p></li>
<li><p><strong>transformed_table</strong> – output table name for table with applied transformations dependent on complete survey dataset</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.generate_input_processing_function">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">generate_input_processing_function</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stage_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_schema</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datetime_column_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformation_functions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source_file_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write_mode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'overwrite'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_map</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">','</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cast_to_double_list</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_hadoop_read_write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.generate_input_processing_function" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate an input file processing stage function and register it.
Returns dataframe for use in testing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>include_hadoop_read_write</strong> – set to False for use in testing on non-hadoop environments</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>See underlying functions for other parameter documentation.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.geography_and_imputation_dependent_processing">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">geography_and_imputation_dependent_processing</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rural_urban_lookup_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.geography_and_imputation_dependent_processing" title="Permalink to this definition">¶</a></dt>
<dd><p>Processing that depends on geographies and and imputed demographic infromation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_survey_table</strong> – name of the table containing data to be processed</p></li>
<li><p><strong>rural_urban_lookup_path</strong> – path to the rural urban lookup to be joined onto responses</p></li>
<li><p><strong>edited_table</strong> – name of table to write processed data to</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.impute_demographic_columns">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">impute_demographic_columns</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">imputed_values_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.impute_demographic_columns" title="Permalink to this definition">¶</a></dt>
<dd><p>Impute values for sex, ethnicity and date of birth.
Assumes that columns to be imputed have been filled forwards, as the latest value from each participant is used.
Specific imputations are carried out for for each key demographic column. The resulting columns should have no
missing values.
Stores imputed values in a lookup table, for reuse in subsequent imputation rounds. This table is also backed up
with a datetime suffix.
Also outputs a table of survey response records with imputed values.
Note that this stage depends on geography information from the sample files being available
(from sample file processing).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – name of HIVE table containing survey responses for imputation, containing <cite>key_columns</cite></p></li>
<li><p><strong>imputed_values_table</strong> – name of HIVE table containing previously imputed values by participant</p></li>
<li><p><strong>survey_responses_imputed_table</strong> – name of HIVE table to write survey responses following imputation</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.join_blood_positive_lookup">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">join_blood_positive_lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lookup_table_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.join_blood_positive_lookup" title="Permalink to this definition">¶</a></dt>
<dd><p>Stage to join blood positive lookup table</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.join_geographic_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">join_geographic_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">geographic_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.join_geographic_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Join weights file onto survey data by household id.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>geographic_table</strong> – input table name for household data with geographic data</p></li>
<li><p><strong>survey_responses_table</strong> – input table for individual participant responses</p></li>
<li><p><strong>geographic_responses_table</strong> – output table name for joined survey responses and household geographic data</p></li>
<li><p><strong>id_column</strong> – column containing id to join the 2 input tables</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.join_vaccination_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">join_vaccination_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">participant_records_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nims_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vaccination_data_table</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.join_vaccination_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Join NIMS vaccination data onto participant level records and derive vaccination status using NIMS and CIS data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>participant_records_table</strong> – input table containing participant level records to join</p></li>
<li><p><strong>nims_table</strong> – nims table containing records to be joined to participant table</p></li>
<li><p><strong>vaccination_data_table</strong> – output table name for the joined nims and participant table</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.lab_report">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">lab_report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">swab_report_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">blood_report_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">pyspark.sql.dataframe.DataFrame</span></span></span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.lab_report" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate reports of most recent 7 days of swab and blood data</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.lookup_based_editing">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">lookup_based_editing</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cohort_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">travel_countries_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tenure_group_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.lookup_based_editing" title="Permalink to this definition">¶</a></dt>
<dd><p>Edit columns based on mappings from lookup files. Often used to correct data quality issues.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_survey_table</strong> – input table name for reference table</p></li>
<li><p><strong>cohort_lookup_path</strong> – input file path name for cohort corrections lookup file</p></li>
<li><p><strong>travel_countries_lookup_path</strong> – input file path name for travel_countries corrections lookup file</p></li>
<li><p><strong>edited_table</strong> – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.process_regex_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">process_regex_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">regex_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.process_regex_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Process regex data and combine result with survey responses data</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.process_soc_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">process_soc_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">inconsistences_resolution_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unioned_soc_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformed_soc_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">coding_errors_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.process_soc_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Process soc data and combine result with survey responses data</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.process_soc_deltas">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">process_soc_deltas</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">soc_file_pattern</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source_file_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_processed</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_invalid</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">latest_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">start_date</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">end_date</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.process_soc_deltas" title="Permalink to this definition">¶</a></dt>
<dd><p>Process soc data and combine result with survey responses data</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.record_level_interface">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">record_level_interface</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">csv_editing_file</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unique_id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unique_id_list</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filtered_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.record_level_interface" title="Permalink to this definition">¶</a></dt>
<dd><p>This stage does two type of edits in a given table from HIVE given an unique_id column.
Either value level editing or filtering editing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – HIVE table containing responses to edit</p></li>
<li><p><strong>csv_editing_file</strong> – <p>defines the editing from old values to new values in the HIVE tables
Columns expected</p>
<blockquote>
<div><ul>
<li><p>id_column_name (optional)</p></li>
<li><p>id</p></li>
<li><p>dataset_name</p></li>
<li><p>target_column</p></li>
<li><p>old_value</p></li>
<li><p>new_value</p></li>
</ul>
</div></blockquote>
</p></li>
<li><p><strong>unique_id_column</strong> – unique id that will be edited</p></li>
<li><p><strong>unique_id_list</strong> – list of ids to be filtered</p></li>
<li><p><strong>edited_survey_responses_table</strong> – HIVE table to write edited responses</p></li>
<li><p><strong>filtered_survey_responses_table</strong> – HIVE table when they have been filtered out from survey responses</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.register_pipeline_stage">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">register_pipeline_stage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.register_pipeline_stage" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorator to register a pipeline stage function.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.replace_design_weights">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">replace_design_weights</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">design_weight_lookup_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_weight_columns</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.replace_design_weights" title="Permalink to this definition">¶</a></dt>
<dd><p>Temporary stage to replace design weights by lookup.
Also makes temporary edits to fix raw data issues in geographies.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.report">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">unique_id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_failure_flag_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">duplicate_count_column_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_survey_responses_errors_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_errors_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_directory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tables_to_count</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_priority_map</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.report" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a excel spreadsheet with multiple sheets to summarise key data from various
tables regarding the running of the pipeline; using overall and most recent statistics.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>unique_id_column</strong> – column that should hold unique id for each row in responses file</p></li>
<li><p><strong>validation_failure_flag_column</strong> – name of the column containing the previously created to contain validation error messages
name should match that created in validate_survey_responses stage</p></li>
<li><p><strong>duplicate_count_column_name</strong> – name of the column containing the previously created to contain count of rows that repeat
on the responses table. name should match that created in validate_survey_responses stage</p></li>
<li><p><strong>valid_survey_responses_table</strong> – table name of hdfs table of survey responses passing validation checks</p></li>
<li><p><strong>invalid_survey_responses_table</strong> – table name of hdfs table of survey responses failing validation checks</p></li>
<li><p><strong>output_directory</strong> – output folder location to store the report</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.sample_file_ETL">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">sample_file_ETL</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">household_level_populations_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">old_sample_file</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_sample_file</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_sample_source_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">postcode_lookup</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">master_sample_file</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_weight_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">country_lookup</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lsoa_cis_lookup</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tranche_file_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tranche_strata_columns</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.sample_file_ETL" title="Permalink to this definition">¶</a></dt>
<dd><p>Process a new sample file, to union it with previous sample data and calculate new swab and antibody design weights.
Creates a table of geographies and design weights per household.</p>
<p>Carries out different scenarios for antibody design weight for either:
1. Where no tranche is provided, or no new households have been sampled
2. Where a tranche has been provided and new households have been sampled</p>
<p><code class="docutils literal notranslate"><span class="pre">old_sample_file</span></code> may point to the same table as <code class="docutils literal notranslate"><span class="pre">design_weight_table</span></code>, to reuse the values from the previous
sample file processing run.</p>
<p>To process a new sample file, the following <em>must</em> be updated:
- <code class="docutils literal notranslate"><span class="pre">new_sample_file</span></code>
- <code class="docutils literal notranslate"><span class="pre">new_sample_source_name</span></code>
- <code class="docutils literal notranslate"><span class="pre">tranche_file_path</span></code></p>
<p>The output <code class="docutils literal notranslate"><span class="pre">design_weight_table</span></code> is also stored as a backup table with the current datetime.</p>
<p class="rubric">Notes</p>
<p>Lookup tables are referenced here are used to get data that are missing on the master sample and sample
files, which are required to link on postcode. Once these issues are resolved, this part of the code may be
simplified to include only:
- household_level_populations_table
- old_sample_file
- new_sample_file
- new_sample_source_name
- tranche_file_path
- tranche_strata_columns</p>
<p>This is dependent on receiving the new sample file in the format expected as specified in the excel specification.</p>
<dl class="simple">
<dt>household_level_populations_table</dt><dd><p>HIVE table create by household level population calculation, containing population by CIS area and country</p>
</dd>
<dt>old_sample_file</dt><dd><p>HIVE table containing the previously processed sample files, including design weights</p>
</dd>
<dt>new_sample_file</dt><dd><p>CSV file or HIVE table containing the new sample to be processed</p>
</dd>
<dt>new_sample_source_name</dt><dd><p>string constant to be stored as the sample source name for the new sample records</p>
</dd>
<dt>postcode_lookup</dt><dd><p>HIVE table containing the NSPL postcode lookup</p>
</dd>
<dt>master_sample_file</dt><dd><p>HIVE table containing the master sample</p>
</dd>
<dt>design_weight_table</dt><dd><p>HIVE table to write household geographies and design weights to</p>
</dd>
<dt>country_lookup</dt><dd><p>HIVE table containing country code 12 to country name lookup</p>
</dd>
<dt>lsoa_cis_lookup</dt><dd><p>HIVE table containing LSOA 11 to CIS area 20 lookup</p>
</dd>
<dt>tranche_file_path</dt><dd><p>path to tranche CSV file, if a tranche is required for the current sample file, otherwise leave empty in config</p>
</dd>
<dt>tranche_strata_columns</dt><dd><p>list of column names to be used as strata in tranche factor calculations</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.tables_to_csv">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">tables_to_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outgoing_directory</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tables_to_csv_config_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">category_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">{}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'|'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extension</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'.txt'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dry_run</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.tables_to_csv" title="Permalink to this definition">¶</a></dt>
<dd><p>Writes data from an existing HIVE table to csv output, including mapping of column names and values.
Takes a yaml file in which HIVE table name and csv table name are defined as well as columns to be
included in the csv file by a select statement.
Optionally also point to an update map to be used for the variable name mapping of these outputs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outgoing_directory</strong> – path to write output CSV files on HDFS</p></li>
<li><p><strong>tables_to_csv_config_file</strong> – path to YAML config file to define input tables and output CSV names</p></li>
<li><p><strong>category_map</strong> – name of the category map for converting category strings to integers</p></li>
<li><p><strong>dry_run</strong> – when set to True, will delete files after they are written (for testing). Default is False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.union_survey_response_files">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">union_survey_response_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tables_to_process</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.union_survey_response_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Union survey response for v0, v1 and v2, and write to table.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tables_to_process</strong> – input tables for extracting each of the transformed survey responses tables</p></li>
<li><p><strong>output_survey_table</strong> – output table name for the combine file of all unioned survey responses</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.validate_survey_responses">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">validate_survey_responses</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">duplicate_count_column_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_failure_flag_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_validation_failures_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_validation_failures_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.validate_survey_responses" title="Permalink to this definition">¶</a></dt>
<dd><p>Populate error column with outcomes of specific validation checks against fully
transformed survey dataset.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – input table name for fully transformed survey table</p></li>
<li><p><strong>duplicate_count_column_name</strong> – column name in which to count duplicates of rows within the dataframe</p></li>
<li><p><strong>validation_failure_flag_column</strong> – name for error column wherein each of the validation checks results are appended</p></li>
<li><p><strong>valid_survey_responses_table</strong> – table containing results that passed the error checking process</p></li>
<li><p><strong>invalid_survey_responses_table</strong> – table containing results that failed the error checking process</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Welcome to cishouseholds’s documentation!</p>
        </div>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, CIS Development Team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>