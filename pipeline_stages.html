
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Pipeline Stages &#8212; cishouseholds  documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to cishouseholds’s documentation!" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="index.html">
<p class="title">cishouseholds</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  Pipeline Stages
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ONS-SST/cis_households" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                

<nav id="bd-toc-nav">
    
</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pipeline-stages">
<h1>Pipeline Stages<a class="headerlink" href="#pipeline-stages" title="Permalink to this headline">¶</a></h1>
<p>Stages that can be run by the pipeline, when specified in the main pipeline configuration file.</p>
<span class="target" id="module-cishouseholds.pipeline.pipeline_stages"></span><dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.aggregated_output">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">aggregated_output</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">apply_aggregate_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_table_to_aggregate</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_group</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_window_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order_window_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">apply_function_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_to_assign_list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.aggregated_output" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>apply_window</strong> – </p></li>
<li><p><strong>apply_groupby</strong> – </p></li>
<li><p><strong>aggregated_output</strong> – </p></li>
<li><p><strong>column_name_to_assign_list</strong> – </p></li>
<li><p><strong>column_group</strong> – </p></li>
<li><p><strong>column_window_list</strong> – </p></li>
<li><p><strong>function_list</strong> – </p></li>
<li><p><strong>column_list_to_apply_function</strong> – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.blind_csv_to_table">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">blind_csv_to_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.blind_csv_to_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert a single csv file to a HDFS table by inferring a schema</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.csv_to_table">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">csv_to_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_operations</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">list</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.csv_to_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert a list of csv files into a HDFS table</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.delete_tables_stage">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">delete_tables_stage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">Union</span><span class="p"><span class="pre">[</span></span><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pattern</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Optional</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.delete_tables_stage" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes HIVE tables. For use at the start of a pipeline run, to reset pipeline logs and data.
Should not be used in production, as all tables may be deleted.</p>
<p>Use one or more of the optional parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>prefix</strong> – remove all tables with a given table name prefix (see config for current prefix)</p></li>
<li><p><strong>table_names</strong> – one or more absolute table names to delete (including prefix)</p></li>
<li><p><strong>pattern</strong> – drop tables where table name matches pattern in SQL format (e.g. “%_responses_%”)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.execute_union_dependent_transformations">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">execute_union_dependent_transformations</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">unioned_survey_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformed_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.execute_union_dependent_transformations" title="Permalink to this definition">¶</a></dt>
<dd><p>Transformations that require the union of the different input survey response files.
Includes combining data from different files and filling forwards or backwards over time.
:param unioned_survey_table: input table name for table containing the combined survey responses tables
:param transformed_table: output table name for table with applied transformations dependent on complete survey dataset</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.generate_input_processing_function">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">generate_input_processing_function</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stage_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_schema</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datetime_column_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformation_functions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source_file_column</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write_mode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'overwrite'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_name_map</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">','</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cast_to_double_list</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_hadoop_read_write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.generate_input_processing_function" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate an input file processing stage function and register it.</p>
<p>Returns dataframe for use in testing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>include_hadoop_read_write</strong> – set to False for use in testing on non-hadoop environments</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>See underlying functions for other parameter documentation.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.geography_and_imputation_dependent_processing">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">geography_and_imputation_dependent_processing</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">imputed_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_imputed_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.geography_and_imputation_dependent_processing" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply processing that depends on the imputation and geographic columns being created
:param imputed_responses_table:
:param response_records_table:
:param invalid_response_records_table:
:param output_imputed_responses_table:
:param key_columns:</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.impute_demographic_columns">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">impute_demographic_columns</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">imputed_values_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">survey_responses_imputed_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key_columns</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.impute_demographic_columns" title="Permalink to this definition">¶</a></dt>
<dd><p>Imputes values for key demographic columns.
Applies filling forward for listed columns. Specific imputations are then used for sex, ethnicity and date of birth.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – name of HIVE table containing survey responses for imputation, containing <cite>key_columns</cite></p></li>
<li><p><strong>imputed_values_table</strong> – name of HIVE table containing previously imputed values</p></li>
<li><p><strong>survey_responses_imputed_table</strong> – name of HIVE table to write survey responses following imputation</p></li>
<li><p><strong>key_columns</strong> – names of key demographic columns to be filled forwards</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.join_geographic_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">join_geographic_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">geographic_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">geographic_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.join_geographic_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Join weights file onto survey data by household id.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>geographic_table</strong> – input table name for household data with geographic data</p></li>
<li><p><strong>survey_responses_table</strong> – input table for individual participant responses</p></li>
<li><p><strong>geographic_responses_table</strong> – output table name for joined survey responses and household geographic data</p></li>
<li><p><strong>id_column</strong> – column containing id to join the 2 input tables</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.join_vaccination_data">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">join_vaccination_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">participant_records_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nims_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vaccination_data_table</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.join_vaccination_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Join NIMS vaccination data onto participant level records and derive vaccination status using NIMS and CIS data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>participant_records_table</strong> – input table containing participant level records to join</p></li>
<li><p><strong>nims_table</strong> – nims table containing records to be joined to participant table</p></li>
<li><p><strong>vaccination_data_table</strong> – output table name for the joined nims and participant table</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.lookup_based_editing">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">lookup_based_editing</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cohort_lookup_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">travel_countries_lookup_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rural_urban_lookup_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tenure_group_path</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">edited_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.lookup_based_editing" title="Permalink to this definition">¶</a></dt>
<dd><p>Edit columns based on mappings from lookup files. Often used to correct data quality issues.
:param input_table: input table name for reference table
:param cohort_lookup_path: input file path name for cohort corrections lookup file
:param travel_countries_lookup_path: input file path name for travel_countries corrections lookup file
:param edited_table:</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.merge_blood_ETL">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">merge_blood_ETL</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_responses_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_antibody_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">blood_files_to_exclude</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merged_1to1_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joined_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">xtox_flagged_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validated_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merged_responses_antibody_data</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">antibody_merge_residuals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">antibody_merge_failed_records</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.merge_blood_ETL" title="Permalink to this definition">¶</a></dt>
<dd><p>High level function for joining antibody/blood test result data to survey responses.
Should be run before the PCR/swab result merge.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – name of HIVE table containing survey response records</p></li>
<li><p><strong>antibody_table</strong> – name of HIVE table containing antibody/blood result records</p></li>
<li><p><strong>swab_files_to_exclude</strong> – antibody/blood result files that should be excluded from the merge.
Used to remove files that are found to contain invalid data.</p></li>
<li><p><strong>swab_output_tables</strong> – <dl class="simple">
<dt>names of the three output tables:</dt><dd><ol class="arabic simple">
<li><p>survey responses and successfully joined results</p></li>
<li><p>residual antibody/blood result records, where there was no barcode match to join on</p></li>
<li><p>antibody/blood result records that failed to meet the criteria for joining</p></li>
</ol>
</dd>
</dl>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.merge_swab_ETL">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">merge_swab_ETL</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_survey_responses_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_swab_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">swab_files_to_exclude</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merged_1to1_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joined_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">xtox_flagged_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validated_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merged_responses_antibody_swab_data</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">swab_merge_residuals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">swab_merge_failed_records</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.merge_swab_ETL" title="Permalink to this definition">¶</a></dt>
<dd><p>High level function for joining PCR test result data to survey responses.
Should be run following the antibody/blood result merge.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – name of HIVE table containing survey response records</p></li>
<li><p><strong>swab_table</strong> – name of HIVE table containing PCR/swab result records</p></li>
<li><p><strong>swab_files_to_exclude</strong> – PCR/swab result files that should be excluded from the merge.
Used to remove files that are found to contain invalid data.</p></li>
<li><p><strong>swab_output_tables</strong> – <dl class="simple">
<dt>names of the three output tables:</dt><dd><ol class="arabic simple">
<li><p>survey responses and successfully joined results</p></li>
<li><p>residual PCR/swab result records, where there was no barcode match to join on</p></li>
<li><p>PCR/swab result records that failed to meet the criteria for joining</p></li>
</ol>
</dd>
</dl>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.outer_join_antibody_results">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">outer_join_antibody_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">antibody_test_result_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">joined_antibody_test_result_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">failed_join_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.outer_join_antibody_results" title="Permalink to this definition">¶</a></dt>
<dd><p>Outer join of data for two antibody/blood test targets (S and N protein antibodies).
Creates a single record per blood sample.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>antibody_test_result_table</strong> – name of HIVE table to read antibody/blood test results from, where blood samples may have more than one record</p></li>
<li><p><strong>joined_antibody_test_result_table</strong> – name of HIVE table to write successfully joined records, where each blood sample has one record</p></li>
<li><p><strong>failed_join_table</strong> – name of HIVE table to write antibody/blood test results that failed to merge.
Specifically, those with more than two records in the unjoined data.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.pre_calibration">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">pre_calibration</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">design_weight_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">individual_level_populations_for_non_response_adjustment_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">survey_response_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">responses_pre_calibration_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre_calibration_config_path</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.pre_calibration" title="Permalink to this definition">¶</a></dt>
<dd><p>Survey data broken down in different datasets is merged with household_samples_dataset
Non-response adjustment is calculated and the design weights
are adjusted by the non-response rates producing desgin weights adjusted.
Calibration variables are calculated and all the files(dataframes) are written to HIVE
for the weight calibration
At the end of this processing stage 24 datasets (files will be produced): 6 datasets for each country</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>design_weight_table</strong> – name of HIVE table containing household level design weights</p></li>
<li><p><strong>individual_level_populations_for_non_response_adjustment_table</strong> – name of HIVE table containing populations for non-response adjustment</p></li>
<li><p><strong>survey_response_table</strong> – name of HIVE table containing survey responses</p></li>
<li><p><strong>responses_pre_calibration_table</strong> – name of HIVE table to write data for weight calibration</p></li>
<li><p><strong>pre_calibration_config_path</strong> – path to YAML pre-calibration config file</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.record_level_interface">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">record_level_interface</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">csv_editing_file</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unique_id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unique_id_list</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">edited_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filtered_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.record_level_interface" title="Permalink to this definition">¶</a></dt>
<dd><p>This stage does two type of edits in a given table from HIVE given an unique_id column.
Either value level editing or filtering editing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – HIVE table containing responses to edit</p></li>
<li><p><strong>csv_editing_file</strong> – <p>defines the editing from old values to new values in the HIVE tables
Columns expected</p>
<blockquote>
<div><ul>
<li><p>id</p></li>
<li><p>dataset_name</p></li>
<li><p>target_column</p></li>
<li><p>old_value</p></li>
<li><p>new_value</p></li>
</ul>
</div></blockquote>
</p></li>
<li><p><strong>unique_id_column</strong> – unique id that will be edited</p></li>
<li><p><strong>unique_id_list</strong> – list of ids to be filtered</p></li>
<li><p><strong>edited_survey_responses_table</strong> – HIVE table to write edited responses</p></li>
<li><p><strong>filtered_survey_responses_table</strong> – HIVE table when they have been filtered out from survey responses</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.register_pipeline_stage">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">register_pipeline_stage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.register_pipeline_stage" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorator to register a pipeline stage function.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.report">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">unique_id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_failure_flag_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">duplicate_count_column_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_survey_responses_errors_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_errors_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_directory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tables_to_count</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_priority_map</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.report" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a excel spreadsheet with multiple sheets to summarise key data from various
tables regarding the running of the pipeline; using overall and most recent statistics.
:param unique_id_column: column that should hold unique id for each row in responses file
:param validation_failure_flag_column: name of the column containing the previously created to containt validation error messages</p>
<blockquote>
<div><p>name should match that created in validate_survey_responses stage</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>duplicate_count_column_name</strong> – name of the column containing the previously created to containt count of rows that repeat
on the responses table. name should match that created in validate_survey_responses stage</p></li>
<li><p><strong>valid_survey_responses_table</strong> – table name of hdfs table of survey responses passing validation checks</p></li>
<li><p><strong>invalid_survey_responses_table</strong> – table name of hdfs table of survey responses failing validation checks</p></li>
<li><p><strong>output_directory</strong> – output folder location to store the report</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.tables_to_csv">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">tables_to_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">outgoing_directory</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tables_to_csv_config_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">category_map</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'|'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extension</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'.txt'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dry_run</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.tables_to_csv" title="Permalink to this definition">¶</a></dt>
<dd><p>Writes data from an existing HIVE table to csv output, including mapping of column names and values.
Takes a yaml file in which HIVE table name and csv table name are defined as well as columns to be
included in the csv file by a select statement.
Optionally also point to an update map to be used for the variable name mapping of these outputs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outgoing_directory</strong> – path to write output CSV files on HDFS</p></li>
<li><p><strong>tables_to_csv_config_file</strong> – path to YAML config file to define input tables and output CSV names</p></li>
<li><p><strong>category_map</strong> – name of the category map for converting category strings to integers</p></li>
<li><p><strong>dry_run</strong> – when set to True, will delete files after they are written (for testing). Default is False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.union_survey_response_files">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">union_survey_response_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tables_to_union</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unioned_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.union_survey_response_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Union survey response for v0, v1 and v2, and write to table.
:param unioned_survey_responses_table: input tables for extracting each of the transformed survey responses tables
:param unioned_survey_responses_table: output table name for the combine file of all unioned survey responses</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cishouseholds.pipeline.pipeline_stages.validate_survey_responses">
<span class="sig-prename descclassname"><span class="pre">cishouseholds.pipeline.pipeline_stages.</span></span><span class="sig-name descname"><span class="pre">validate_survey_responses</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">duplicate_count_column_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validation_failure_flag_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_survey_responses_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">valid_validation_failures_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">invalid_validation_failures_table</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cishouseholds.pipeline.pipeline_stages.validate_survey_responses" title="Permalink to this definition">¶</a></dt>
<dd><p>Populate error column with outcomes of specific validation checks against fully
transformed survey dataset.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>survey_responses_table</strong> – input table name for fully transformed survey table</p></li>
<li><p><strong>duplicate_count_column_name</strong> – column name in which to count duplicates of rows within the dataframe</p></li>
<li><p><strong>validation_failure_flag_column</strong> – name for error column wherein each of the validation checks results are appended</p></li>
<li><p><strong>valid_survey_responses_table</strong> – table containing results that passed the error checking process</p></li>
<li><p><strong>invalid_survey_responses_table</strong> – table containing results that failed the error checking process</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Welcome to cishouseholds’s documentation!</p>
        </div>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, CIS Development Team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>